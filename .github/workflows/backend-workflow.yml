name: Build, push Docker image and deploy

on:
    push:
        branches:
            - main
        paths:
            - app/backend/**
            

jobs:
    build-and-push-image:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4.2.2
              with:
                fetch-depth: 2

            - name: Get Commit SHA
              shell: bash
              run: |
                echo "SHA_SHORT=$(git rev-parse --short "$GITHUB_SHA")" >> "$GITHUB_ENV"

            - name: Login to DockerHub
              uses: docker/login-action@v2
              with:
                username: ${{ secrets.DOCKERHUB_USERNAME }}
                password: ${{ secrets.DOCKERHUB_PASSWORD }}
            
            - name: Build and push to DockerHub
              uses: docker/build-push-action@v6
              with:
                context: app/frontend/.
                push: true
                tags: bijaydockerhub/react-express-app:front-${{ env.SHA_SHORT }}
                # tags: ${{ env.DOCKERHUB }}/bijaypachhai/react-frontend:${{ github.sha::5 }}

    deploy:
      runs-on: ubuntu-latest
      needs: build-and-push-image
      steps:
        - name: Deploy
          run: |
            echo "Successfully deployed"
            ssh -A -tt -i ${{ secrets.SERVER_KEY }} -o StrictHostKeyChecking=no -p 22 adminuser@${{ secrets.SERVER_ADDRESS }} "cd app/ && bash deploy.sh --backend --backend-tag ${{ env.SHA_SHORT }}"